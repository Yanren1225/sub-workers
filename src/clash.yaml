mixed-port: 7890
allow-lan: true
mode: rule
log-level: info
external-controller: :9090
ipv6: true

profile:
  store-selected: true

geodata-mode: true
geox-url:
  geoip: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-geodata/geoip-all.dat"
  geosite: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-geodata/geosite-all.dat"
  mmdb: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-geodata/Country-all.mmdb"
  asn: "https://github.com/DustinWin/ruleset_geodata/releases/download/mihomo-geodata/Country-ASN.mmdb"

tun:
  enable: true
  stack: mixed
  device: mihomo-tun
  auto-route: true
  auto-detect-interface: true
  dns-hijack:
    - any:53
  strict-route: true
  mtu: 1500
  gso: true
  gso-max-size: 65536
  udp-timeout: 300
  exclude-interface:
    - Tailscale
  route-exclude-address-set:
  # route-exclude-address:
  #   - '100.64.0.0/10'
  #   - fd7a:115c:a1e0::/48
  # inet4_route_address:
  #   - 0.0.0.0/1
  #   - 128.0.0.0/1
  # inet6_route_address:
  #   - '::/1'
  #   - '8000::/1'
dns:
  enable: true
  ipv6: true
  prefer-h3: true
  listen: ":53"
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter-mode: blacklist
  direct-nameserver-follow-policy: true
  default-nameserver:
    - system
    - 119.29.29.29
    - 223.5.5.5
    - 2400:3200::1
    - 2402:4e00:3200::b
  nameserver:
    - https://cloudflare-dns.com/dns-query
    - https://dns.google/dns-query
    - tls://1.1.1.1
    - tls://8.8.4.4
  proxy-server-nameserver:
    - https://doh.pub/dns-query
    - https://dns.alidns.com/dns-query
  direct-nameserver:
    - https://doh.pub/dns-query
    - https://dns.alidns.com/dns-query
    - https://223.5.5.5/dns-query
    - https://doh.360.cn/dns-query
  fake-ip-filter:
    - rule-set:FAKEIP_FILTER
    - "*.lan"
    - "*.local"
    - "+.market.xiaomi.com"
    - "+.msftconnecttest.com"
    - "+.msftncsi.com"
    - localhost.ptlogin2.qq.com
    - www.msftconnecttest.com
    - time.*.com
    - "*.msftncsi.com"
  nameserver-policy:
    rule-set:YanrenDirect: &cn_dns
      - https://doh.pub/dns-query
      - https://dns.alidns.com/dns-query
      - 119.29.29.29
      - 223.5.5.5
      - system
    rule-set:CN,GAMES_CN,APPLE_CN,MICROSOFT_CN: *cn_dns
    # geosite:cn,private: &cn_dns
    #   - https://doh.pub/dns-query
    #   - https://dns.alidns.com/dns-query
    #   - 119.29.29.29
    #   - 223.5.5.5
    #   - system
    # geosite:apple-cn,microsoft-cn: *cn_dns
    # geosite:games-cn: *cn_dns
    # rule-set:YanrenDirect,CN,GAMES_CN,APPLE_CN,MICROSOFT_CN: *cn_dns

sniffer:
  enable: true
  override-destination: true
  sniff:
    TLS:
      ports: [443, 8443]
    HTTP:
      ports: [80, 8080-8888]
      active: true
    QUIC:
      ports: [443]
      active: true

proxy-providers:
  SUB:
    type: http
    interval: 86400
    health-check:
      enable: true
      lazy: true
      interval: 1200
      url: https://www.gstatic.com/generate_204
    proxy: DIRECT
    url: "__SUB_URL__"
    path: ./provider_sub.yaml

proxy-groups:
  - name: PROXY
    type: select
    proxies:
      - AUTO
      - HK_AUTO
      - JP_AUTO
      - SG_AUTO
      - USA_AUTO
      - MANUAL
      - DIRECT

  - name: AUTO
    type: url-test
    url: https://www.gstatic.com/generate_204
    lazy: true
    initial: 0
    interval: 1200
    tolerance: 50
    use:
      - SUB

  - name: HK_AUTO
    type: url-test
    url: https://www.gstatic.com/generate_204
    lazy: true
    initial: 0
    interval: 1200
    tolerance: 50
    use:
      - SUB
    filter: "(?i)香港|HK|Hong Kong"

  - name: JP_AUTO
    type: url-test
    url: https://www.gstatic.com/generate_204
    lazy: true
    initial: 0
    interval: 1200
    tolerance: 50
    use:
      - SUB
    filter: "(?i)日本|JP|Japan"

  - name: SG_AUTO
    type: url-test
    url: https://www.gstatic.com/generate_204
    lazy: true
    initial: 0
    interval: 1200
    tolerance: 50
    use:
      - SUB
    filter: "(?i)新加坡|狮城|SG|Singapore"

  - name: USA_AUTO
    type: url-test
    url: https://www.gstatic.com/generate_204
    lazy: true
    initial: 0
    interval: 1200
    tolerance: 50
    use:
      - SUB
    filter: "(?i)美国|US|United States"

  - name: MANUAL
    type: select
    use:
      - SUB

  - name: BLOCK
    type: select
    proxies:
      - REJECT
      - DIRECT
      - PROXY

  - name: FINAL
    type: select
    proxies:
      - PROXY
      - DIRECT

rules:
  # 自用规则
  - RULE-SET,YanrenPrivateIP,DIRECT,no-resolve
  - RULE-SET,YanrenDirect,DIRECT
  - RULE-SET,YanrenProxy,PROXY
  - RULE-SET,YanrenReject,BLOCK
  # 社区规则
  - RULE-SET,PRIVATE_IP,DIRECT,no-resolve
  - RULE-SET,CN,DIRECT
  - RULE-SET,CN_IP,DIRECT,no-resolve
  - RULE-SET,GAMES_CN,DIRECT
  - RULE-SET,APPLE_CN,DIRECT
  - RULE-SET,MICROSOFT_CN,DIRECT
  - RULE-SET,TELEGRAM,PROXY
  - RULE-SET,PROXY,PROXY
  # GEO SITE
  # - GEOSITE,games-cn,DIRECT
  # - GEOSITE,apple-cn,DIRECT
  # - GEOSITE,microsoft-cn,DIRECT
  # - GEOSITE,cn,DIRECT
  # GEO IP
  - GEOIP,CN,DIRECT,no-resolve
  - MATCH,FINAL

rule-providers:
  YanrenProxy:
    type: http
    behavior: classical
    format: text
    url: https://cdn.jsdelivr.net/gh/Yanren1225/rules@main/Proxy.txt
    path: ./ruleset/YanrenProxy.txt
    interval: 3600
  YanrenDirect:
    type: http
    behavior: classical
    format: text
    url: https://cdn.jsdelivr.net/gh/Yanren1225/rules@main/Direct.txt
    path: ./ruleset/YanrenDirect.txt
    interval: 3600
  YanrenPrivateIP:
    type: http
    behavior: classical
    format: text
    url: https://cdn.jsdelivr.net/gh/Yanren1225/rules@main/PrivateIP.txt
    path: ./ruleset/YanrenPrivateIP.txt
    interval: 3600
  YanrenReject:
    type: http
    behavior: classical
    format: text
    url: https://cdn.jsdelivr.net/gh/Yanren1225/rules@main/Reject.txt
    path: ./ruleset/YanrenReject.txt
    interval: 3600

  CN:
    type: http
    behavior: domain
    format: mrs
    path: ./ruleset/cn.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/cn.mrs"
    interval: 86400
  CN_IP:
    type: http
    behavior: ipcidr
    format: mrs
    path: ./ruleset/cnip.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/cnip.mrs"
    interval: 86400
  GAMES_CN:
    type: http
    behavior: domain
    format: mrs
    path: ./ruleset/games-cn.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/games-cn.mrs"
    interval: 86400
  APPLE_CN:
    type: http
    behavior: domain
    format: mrs
    path: ./ruleset/apple-cn.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/apple-cn.mrs"
    interval: 86400
  PROXY:
    type: http
    behavior: domain
    format: mrs
    path: ./ruleset/proxy.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/proxy.mrs"
    interval: 86400
  MICROSOFT_CN:
    type: http
    behavior: domain
    format: mrs
    path: ./ruleset/microsoft-cn.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/microsoft-cn.mrs"
    interval: 86400
  TELEGRAM:
    type: http
    behavior: ipcidr
    format: mrs
    path: ./ruleset/telegramip.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/telegramip.mrs"
    interval: 86400
  FAKEIP_FILTER:
    type: http
    behavior: domain
    format: mrs
    path: ./ruleset/fakeip-filter.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/fakeip-filter.mrs"
    interval: 86400
  PRIVATE_IP:
    type: http
    behavior: ipcidr
    format: mrs
    path: ./ruleset/privateip.mrs
    url: "https://ghfast.top/github.com/DustinWin/ruleset_geodata/releases/download/mihomo-ruleset/privateip.mrs"
    interval: 86400
